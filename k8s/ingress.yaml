apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: medisupply-ingress
  namespace: medisupply
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"

    # --- Autenticación ---
    nginx.ingress.kubernetes.io/auth-url: "http://auth-service.medisupply.svc.cluster.local:5004/verify"
    nginx.ingress.kubernetes.io/auth-method: "POST"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Usuario-Id,X-Usuario-Tipo,X-Usuario-Email"
    nginx.ingress.kubernetes.io/auth-cache-key: "$http_authorization"
    nginx.ingress.kubernetes.io/auth-cache-duration: "200 202 401 5m"
    
    # Excluir rutas públicas de auth_request (bypass completo)
    # IMPORTANTE: Las rutas deben coincidir exactamente, sin trailing slash a menos que sea parte del path
    nginx.ingress.kubernetes.io/no-auth-locations: "/auth/login,/auth/version,/auth/health"

    # --- Autenticación selectiva (rutas públicas) ---
    # NOTA: Las rutas públicas se manejan por:
    # 1. no-auth-locations: excluye auth_request completamente
    # 2. server-snippet location block: maneja OPTIONS y proxy directo
    # 3. auth-snippet: excluye OPTIONS del auth_request (preflight no necesita autenticación)
    # El servicio de autenticación también consulta permissions.json para rutas públicas
    
    # --- Excluir OPTIONS del auth_request (preflight no necesita autenticación) ---
    nginx.ingress.kubernetes.io/auth-snippet: |
      # Permitir todas las peticiones OPTIONS (preflight CORS) sin autenticación
      # Esto es crítico porque el preflight no debe pasar por auth_request
      if ($request_method = 'OPTIONS') {
        return 202;
      }

    # --- Snippet de configuración para CORS y rewrite para /auth ---
    nginx.ingress.kubernetes.io/configuration-snippet: |
      # Validar y establecer origen permitido (frontend)
      set $cors_origin "";
      # Match medisupplyg4.online (with or without subdomain, with or without trailing slash)
      if ($http_origin ~* "^https?://([a-zA-Z0-9-]+\.)?medisupplyg4\.online/?$") {
        set $cors_origin $http_origin;
      }
      # Match hosted app domain
      if ($http_origin ~* "^https?://medisupply-web--medisupply-web\.us-east4\.hosted\.app/?$") {
        set $cors_origin $http_origin;
      }
      # Match localhost for development
      if ($http_origin ~* "^https?://localhost(:[0-9]+)?/?$") {
        set $cors_origin $http_origin;
      }
      
      # CRÍTICO: Manejar preflight OPTIONS ANTES de cualquier procesamiento
      # TODAS las peticiones OPTIONS deben manejarse directamente sin auth_request
      # Esto aplica tanto para rutas públicas como protegidas
      if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 3600 always;
        add_header 'Content-Length' 0 always;
        add_header 'Content-Type' 'text/plain' always;
        return 204;
      }
      
      # Rewrite SOLO para paths /auth: strip /auth prefix
      # /auth/login -> /login (solo aplica a location /auth)
      if ($uri ~* "^/auth/(.+)$") {
        rewrite ^/auth/(.+)$ /$1 break;
      }
      if ($uri = "/auth") {
        rewrite ^/auth$ / break;
      }
      
      # CORS para todas las peticiones
      add_header 'Access-Control-Allow-Origin' $cors_origin always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,X-Requested-With' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
      add_header 'Vary' 'Origin' always;

    # --- Inyectar headers también en respuestas 401/403 (auth_request fallido) ---
    nginx.ingress.kubernetes.io/server-snippet: |
      # Validar origen permitido
      set $cors_allowed_origin "";
      # Match medisupplyg4.online (with or without subdomain, with or without trailing slash)
      if ($http_origin ~* "^https?://([a-zA-Z0-9-]+\.)?medisupplyg4\.online/?$") {
        set $cors_allowed_origin $http_origin;
      }
      # Match hosted app domain
      if ($http_origin ~* "^https?://medisupply-web--medisupply-web\.us-east4\.hosted\.app/?$") {
        set $cors_allowed_origin $http_origin;
      }
      # Match localhost for development
      if ($http_origin ~* "^https?://localhost(:[0-9]+)?/?$") {
        set $cors_allowed_origin $http_origin;
      }
      
      # CRÍTICO: Location blocks con máxima precedencia para rutas públicas
      # Estos se ejecutan ANTES del auth_request y manejan OPTIONS directamente
      
      # Location exacto para /auth/login (máxima precedencia)
      location = /auth/login {
        # Manejar OPTIONS (preflight) directamente sin auth_request
        if ($request_method = 'OPTIONS') {
          add_header 'Access-Control-Allow-Origin' $cors_allowed_origin always;
          add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
          add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,X-Requested-With' always;
          add_header 'Access-Control-Allow-Credentials' 'true' always;
          add_header 'Access-Control-Max-Age' 3600 always;
          add_header 'Content-Length' 0 always;
          add_header 'Content-Type' 'text/plain' always;
          return 204;
        }
        
        # Sin auth_request directive = bypass completo de autenticación
        # Rewrite para quitar el prefijo /auth
        rewrite ^/auth/login$ /login break;
        
        # Proxy directo al servicio sin pasar por verify
        proxy_pass http://auth-service.medisupply.svc.cluster.local:5004;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers para respuestas normales
        add_header 'Access-Control-Allow-Origin' $cors_allowed_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Vary' 'Origin' always;
      }
      
      # Location para /auth/version y /auth/health
      location ~ ^/auth/(version|health)$ {
        # Manejar OPTIONS (preflight) directamente sin auth_request
        if ($request_method = 'OPTIONS') {
          add_header 'Access-Control-Allow-Origin' $cors_allowed_origin always;
          add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
          add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,X-Requested-With' always;
          add_header 'Access-Control-Allow-Credentials' 'true' always;
          add_header 'Access-Control-Max-Age' 3600 always;
          add_header 'Content-Length' 0 always;
          add_header 'Content-Type' 'text/plain' always;
          return 204;
        }
        
        # Sin auth_request directive = bypass completo de autenticación
        # Rewrite para quitar el prefijo /auth
        rewrite ^/auth/(.+)$ /$1 break;
        
        # Proxy directo al servicio sin pasar por verify
        proxy_pass http://auth-service.medisupply.svc.cluster.local:5004;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers para respuestas normales
        add_header 'Access-Control-Allow-Origin' $cors_allowed_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Vary' 'Origin' always;
      }
      
      error_page 401 403 = @error401;
      location @error401 {
        add_header 'Access-Control-Allow-Origin' $cors_allowed_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Vary' 'Origin' always;
        return 401;
      }

spec:
  ingressClassName: nginx
  tls:
  - hosts:
      - api.medisupplyg4.online
    secretName: medisupply-tls

  rules:
    - host: api.medisupplyg4.online
      http:
        paths:
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: auth-service
                port:
                  number: 5004
          - path: /usuarios
            pathType: Prefix
            backend:
              service:
                name: usuarios-service
                port:
                  number: 5001
          - path: /productos
            pathType: Prefix
            backend:
              service:
                name: productos-service
                port:
                  number: 5000
          - path: /ventas
            pathType: Prefix
            backend:
              service:
                name: ventas-service
                port:
                  number: 5002
          - path: /logistica
            pathType: Prefix
            backend:
              service:
                name: logistica-service
                port:
                  number: 5003
          - path: /
            pathType: Prefix
            backend:
              service:
                name: auth-service
                port:
                  number: 5004