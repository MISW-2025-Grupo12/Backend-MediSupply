apiVersion: batch/v1
kind: Job
metadata:
  name: truncate-all-tables
  namespace: medisupply
spec:
  template:
    spec:
      serviceAccountName: medisupply-ksa
      containers:
      - name: psql-client
        image: postgres:15
        command:
          - /bin/bash
          - -c
          - |
            # Instalar postgresql-client si no est√° disponible
            apt-get update && apt-get install -y postgresql-client-15
            
            # Configurar variables
            DB_HOST="localhost"
            DB_PORT="5432"
            
            # Funci√≥n para verificar cantidad de registros
            check_table_count() {
              local DB_NAME=$1
              local DB_USER=$2
              local DB_PASS=$3
              local TABLE=$4
              
              export PGPASSWORD=$DB_PASS
              psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -t -c "SELECT COUNT(*) FROM $TABLE;" 2>/dev/null | tr -d ' ' || echo "0"
            }
            
            # Funci√≥n para truncar tabla individual
            truncate_table() {
              local DB_NAME=$1
              local DB_USER=$2
              local DB_PASS=$3
              local TABLE=$4
              
              export PGPASSWORD=$DB_PASS
              
              # Verificar conteo antes
              COUNT_BEFORE=$(check_table_count "$DB_NAME" "$DB_USER" "$DB_PASS" "$TABLE")
              echo "  üìä Tabla $TABLE: $COUNT_BEFORE registros antes"
              
              # Intentar TRUNCATE
              echo "  üóëÔ∏è  Truncando tabla $TABLE..."
              ERROR_OUTPUT=$(psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "TRUNCATE TABLE $TABLE RESTART IDENTITY CASCADE;" 2>&1)
              TRUNCATE_EXIT=$?
              
              if [ $TRUNCATE_EXIT -ne 0 ]; then
                echo "  ‚ö†Ô∏è  Error al truncar $TABLE: $ERROR_OUTPUT"
                echo "  üîÑ Intentando DELETE..."
                DELETE_OUTPUT=$(psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "DELETE FROM $TABLE;" 2>&1)
                if [ $? -eq 0 ]; then
                  echo "  ‚úÖ DELETE exitoso para $TABLE"
                else
                  echo "  ‚ùå Error en DELETE para $TABLE: $DELETE_OUTPUT"
                fi
              else
                echo "  ‚úÖ TRUNCATE exitoso para $TABLE"
              fi
              
              # Verificar conteo despu√©s
              COUNT_AFTER=$(check_table_count "$DB_NAME" "$DB_USER" "$DB_PASS" "$TABLE")
              echo "  üìä Tabla $TABLE: $COUNT_AFTER registros despu√©s"
              
              if [ "$COUNT_AFTER" != "0" ] && [ "$COUNT_BEFORE" != "0" ]; then
                echo "  ‚ö†Ô∏è  ADVERTENCIA: La tabla $TABLE todav√≠a tiene $COUNT_AFTER registros"
              fi
            }
            
            # Funci√≥n para truncar todas las tablas de una BD en orden
            truncate_db() {
              local DB_NAME=$1
              local DB_USER=$2
              local DB_PASS=$3
              shift 3
              local TABLES=("$@")
              
              echo "üßπ Limpiando $DB_NAME..."
              export PGPASSWORD=$DB_PASS
              
              # Truncar cada tabla individualmente en el orden especificado
              for TABLE in "${TABLES[@]}"; do
                truncate_table "$DB_NAME" "$DB_USER" "$DB_PASS" "$TABLE"
              done
              
              echo "‚úÖ $DB_NAME limpiada"
            }
            
            # Esperar a que Cloud SQL Proxy est√© listo
            echo "‚è≥ Esperando Cloud SQL Proxy..."
            sleep 5
            
            # Truncar LOGISTICA_DB
            truncate_db "logistica_db" "logistica_user" "logistica123!Prod" \
              "ruta_entregas" "entregas" "inventario" "rutas" "bodegas"
            
            # Truncar VENTAS_DB (orden: tablas hijas primero, luego tablas padre)
            truncate_db "ventas_db" "ventas_user" "ventas123!Prod" \
              "sugerencias_cliente" "items_pedido" "evidencias_visitas" "pedidos" "visitas" "planes"
            
            # Truncar PRODUCTOS_DB
            truncate_db "productos_db" "productos_user" "productos123!Prod" \
              "productos" "carga_masiva_jobs" "categorias"
            
            # Truncar USUARIOS_DB
            truncate_db "usuarios_db" "usuarios_user" "usuarios123!Prod" \
              "usuarios" "repartidores" "administradores" "clientes" "vendedores" "proveedores"
            
            echo "‚úÖ Proceso completado!"
        env:
        - name: DB_HOST
          value: "localhost"
        - name: DB_PORT
          value: "5432"
      - name: cloud-sql-proxy
        image: gcr.io/cloudsql-docker/gce-proxy:1.33.2
        command:
          - "/cloud_sql_proxy"
          - "-instances=desarrolloswcloud:us-central1:medisupply-db-prod=tcp:5432"
        securityContext:
          runAsNonRoot: true
      restartPolicy: Never
  backoffLimit: 1

