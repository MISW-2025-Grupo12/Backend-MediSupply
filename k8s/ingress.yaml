apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: medisupply-ingress
  namespace: medisupply
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    # --- Timeouts y tamaño de request ---
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"

    # --- Autenticación ---
    nginx.ingress.kubernetes.io/auth-url: "http://auth-service.medisupply.svc.cluster.local:5004/verify"
    nginx.ingress.kubernetes.io/auth-method: "POST"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Usuario-Id,X-Usuario-Tipo,X-Usuario-Email"
    nginx.ingress.kubernetes.io/auth-cache-key: "$http_authorization"
    nginx.ingress.kubernetes.io/auth-cache-duration: "200 202 401 5m"

    # --- CORS: headers siempre presentes ---
    nginx.ingress.kubernetes.io/configuration-snippet: |
      # Headers CORS (siempre)
      add_header 'Access-Control-Allow-Origin' "$http_origin" always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,X-Requested-With' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
      add_header 'Vary' 'Origin' always;

      # Preflight global
      if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Max-Age' 3600;
        add_header 'Content-Length' 0;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        return 204;
      }

      # Reescribir rutas /auth (Flask interno)
      if ($request_uri ~* ^/auth/(.*)$) {
        rewrite ^/auth/(.*)$ /$1 break;
      }

    # --- Autenticación selectiva (permitir rutas públicas) ---
    nginx.ingress.kubernetes.io/auth-snippet: |
      # Permitir sin autenticación
      if ($request_uri ~* "^/(auth/(login|health|version)|usuarios/api/auth/(registrar-|registro-|login))(/)?$") {
        return 202;
      }
      if ($request_uri ~* "^/(productos|ventas|logistica|usuarios)/health(/)?$") {
        return 202;
      }
      if ($request_uri = "/") {
        return 202;
      }

spec:
  ingressClassName: nginx
  tls:
  - hosts:
      - api.medisupplyg4.online
    secretName: medisupply-tls

  rules:
    - host: api.medisupplyg4.online
      http:
        paths:
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: auth-service
                port:
                  number: 5004
          - path: /usuarios
            pathType: Prefix
            backend:
              service:
                name: usuarios-service
                port:
                  number: 5001
          - path: /productos
            pathType: Prefix
            backend:
              service:
                name: productos-service
                port:
                  number: 5000
          - path: /ventas
            pathType: Prefix
            backend:
              service:
                name: ventas-service
                port:
                  number: 5002
          - path: /logistica
            pathType: Prefix
            backend:
              service:
                name: logistica-service
                port:
                  number: 5003
          - path: /
            pathType: Prefix
            backend:
              service:
                name: auth-service
                port:
                  number: 5004
