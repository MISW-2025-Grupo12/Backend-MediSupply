apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: medisupply-ingress
  namespace: medisupply
  annotations:
    # Usar NGINX Ingress Controller
    kubernetes.io/ingress.class: "nginx"
    
    # Tama√±o m√°ximo del cuerpo del request (para subir videos/evidencias)
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    
    # Autenticaci√≥n con Auth-Service (por defecto para TODAS las rutas)
    nginx.ingress.kubernetes.io/auth-url: "http://auth-service.medisupply.svc.cluster.local:5004/verify"
    nginx.ingress.kubernetes.io/auth-method: "POST"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Usuario-Id,X-Usuario-Tipo,X-Usuario-Email"
    nginx.ingress.kubernetes.io/auth-cache-key: "$http_authorization"
    nginx.ingress.kubernetes.io/auth-cache-duration: "200 202 401 5m"
    
    # üîë SNIPPET: Desactivar autenticaci√≥n para rutas p√∫blicas espec√≠ficas
    nginx.ingress.kubernetes.io/auth-snippet: |
      # Rutas p√∫blicas - bypass auth (return 202 = skip auth)
      if ($request_uri ~* "^/(auth/(login|health|version)|usuarios/api/auth/registrar-cliente)(/)?$") {
        return 202;
      }
      if ($request_uri ~* "^/(usuarios|productos|ventas|logistica)/health(/)?$") {
        return 202;
      }
      if ($request_uri = "/") {
        return 202;
      }
    
    # Configuration snippet: Solo aplicar rewrite a rutas /auth
    nginx.ingress.kubernetes.io/configuration-snippet: |
      if ($request_uri ~* ^/auth/(.*)$) {
        rewrite ^/auth/(.*)$ /$1 break;
      }
    
    # SSL/TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # CORS (manejado por nginx)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://medisupplyg4.online,https://api.medisupplyg4.online,http://localhost:3000,http://localhost:5173"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Content-Type,Authorization,Accept,Origin,X-Requested-With"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    nginx.ingress.kubernetes.io/cors-max-age: "3600"

spec:
  tls:
  - hosts:
    - api.medisupplyg4.online
    secretName: medisupply-tls
  rules:
    - host: api.medisupplyg4.online
      http:
        paths:
          # Auth Service
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: auth-service
                port:
                  number: 5004
          
          # Usuarios
          - path: /usuarios
            pathType: Prefix
            backend:
              service:
                name: usuarios-service
                port:
                  number: 5001
          
          # Productos
          - path: /productos
            pathType: Prefix
            backend:
              service:
                name: productos-service
                port:
                  number: 5000
          
          # Ventas
          - path: /ventas
            pathType: Prefix
            backend:
              service:
                name: ventas-service
                port:
                  number: 5002
          
          # Log√≠stica
          - path: /logistica
            pathType: Prefix
            backend:
              service:
                name: logistica-service
                port:
                  number: 5003
          
          # Root (health check general)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: auth-service
                port:
                  number: 5004
