name: Deploy MediSupply Services

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  PROJECT_ID: desarrolloswcloud
  GKE_CLUSTER: medisupply-cluster-prod
  GKE_ZONE: us-central1-a
  GKE_NAMESPACE: medisupply
  REGISTRY: gcr.io

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.date.outputs.build_date }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version
      id: version
      run: |
        VERSION=$(cat VERSION)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üì¶ Version: $VERSION"
    
    - name: Get build date
      id: date
      run: |
        BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "üìÖ Build Date: $BUILD_DATE"

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      productos: ${{ steps.changes.outputs.productos }}
      usuarios: ${{ steps.changes.outputs.usuarios }}
      ventas: ${{ steps.changes.outputs.ventas }}
      logistica: ${{ steps.changes.outputs.logistica }}
      auth: ${{ steps.changes.outputs.auth }}
      config: ${{ steps.changes.outputs.config }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          productos:
            - 'Productos/**'
          usuarios:
            - 'Usuarios/**'
          ventas:
            - 'Ventas/**'
          logistica:
            - 'Logistica/**'
          auth:
            - 'Auth-Service/**'
            - 'VERSION'
          config:
            - 'k8s/**'
            - '.github/**'

  deploy-productos:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.productos == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run Productos tests
      run: |
        echo "üß™ Ejecutando pruebas de Productos..."
        cd Productos
        pip install -r requirements.txt
        python -m pytest tests/ -v --tb=short
        echo "‚úÖ Pruebas de Productos pasaron correctamente!"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker gcr.io
        gcloud auth configure-docker us-docker.pkg.dev

    - name: Verify Docker authentication
      run: |
        echo "Verificando autenticaci√≥n de Docker..."
        gcloud auth list
        docker pull hello-world
        echo "‚úÖ Docker autenticado correctamente"

    - name: Install gke-gcloud-auth-plugin
      run: |
        echo "Instalando gke-gcloud-auth-plugin..."
        gcloud components install gke-gcloud-auth-plugin --quiet
        echo "‚úÖ Plugin instalado correctamente"

    - name: Get GKE credentials
      run: gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}

    - name: Build and push Productos image
      run: |
        cd Productos
        docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/productos:${{ github.sha }} .
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/productos:${{ github.sha }}
        docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/productos:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/productos:latest
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/productos:latest

    - name: Deploy Productos
      run: |
        kubectl set image deployment/productos-deployment productos=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/productos:${{ github.sha }} -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout status deployment/productos-deployment -n ${{ env.GKE_NAMESPACE }} --timeout=300s

  deploy-usuarios:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.usuarios == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run Usuarios tests
      run: |
        echo "üß™ Ejecutando pruebas de Usuarios..."
        cd Usuarios
        pip install -r requirements.txt
        python -m pytest tests/ -v --tb=short
        echo "‚úÖ Pruebas de Usuarios pasaron correctamente!"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker gcr.io
        gcloud auth configure-docker us-docker.pkg.dev

    - name: Verify Docker authentication
      run: |
        echo "Verificando autenticaci√≥n de Docker..."
        gcloud auth list
        docker pull hello-world
        echo "‚úÖ Docker autenticado correctamente"

    - name: Install gke-gcloud-auth-plugin
      run: |
        echo "Instalando gke-gcloud-auth-plugin..."
        gcloud components install gke-gcloud-auth-plugin --quiet
        echo "‚úÖ Plugin instalado correctamente"

    - name: Get GKE credentials
      run: gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}

    - name: Build and push Usuarios image
      run: |
        cd Usuarios
        docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/usuarios:${{ github.sha }} .
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/usuarios:${{ github.sha }}
        docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/usuarios:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/usuarios:latest
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/usuarios:latest

    - name: Deploy Usuarios
      run: |
        kubectl set image deployment/usuarios-deployment usuarios=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/usuarios:${{ github.sha }} -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout status deployment/usuarios-deployment -n ${{ env.GKE_NAMESPACE }} --timeout=300s

  deploy-ventas:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ventas == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run Ventas tests
      run: |
        echo "üß™ Ejecutando pruebas de Ventas..."
        cd Ventas
        pip install -r requirements.txt
        python -m pytest tests/ -v --tb=short
        echo "‚úÖ Pruebas de Ventas pasaron correctamente!"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker gcr.io
        gcloud auth configure-docker us-docker.pkg.dev

    - name: Verify Docker authentication
      run: |
        echo "Verificando autenticaci√≥n de Docker..."
        gcloud auth list
        docker pull hello-world
        echo "‚úÖ Docker autenticado correctamente"

    - name: Install gke-gcloud-auth-plugin
      run: |
        echo "Instalando gke-gcloud-auth-plugin..."
        gcloud components install gke-gcloud-auth-plugin --quiet
        echo "‚úÖ Plugin instalado correctamente"

    - name: Get GKE credentials
      run: gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}

    - name: Build and push Ventas image
      run: |
        cd Ventas
        docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/ventas:${{ github.sha }} .
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/ventas:${{ github.sha }}
        docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/ventas:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/ventas:latest
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/ventas:latest

    - name: Deploy Ventas
      run: |
        kubectl set image deployment/ventas-deployment ventas=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/ventas:${{ github.sha }} -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout status deployment/ventas-deployment -n ${{ env.GKE_NAMESPACE }} --timeout=300s

  deploy-logistica:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.logistica == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run Logistica tests
      run: |
        echo "üß™ Ejecutando pruebas de Log√≠stica..."
        cd Logistica
        pip install -r requirements.txt
        python -m pytest tests/ -v --tb=short
        echo "‚úÖ Pruebas de Log√≠stica pasaron correctamente!"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker gcr.io
        gcloud auth configure-docker us-docker.pkg.dev

    - name: Verify Docker authentication
      run: |
        echo "Verificando autenticaci√≥n de Docker..."
        gcloud auth list
        docker pull hello-world
        echo "‚úÖ Docker autenticado correctamente"

    - name: Install gke-gcloud-auth-plugin
      run: |
        echo "Instalando gke-gcloud-auth-plugin..."
        gcloud components install gke-gcloud-auth-plugin --quiet
        echo "‚úÖ Plugin instalado correctamente"

    - name: Get GKE credentials
      run: gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}

    - name: Build and push Logistica image
      run: |
        cd Logistica
        docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/logistica:${{ github.sha }} .
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/logistica:${{ github.sha }}
        docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/logistica:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/logistica:latest
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/logistica:latest

    - name: Deploy Logistica
      run: |
        kubectl set image deployment/logistica-deployment logistica=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/logistica:${{ github.sha }} -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout status deployment/logistica-deployment -n ${{ env.GKE_NAMESPACE }} --timeout=300s

  deploy-auth:
    needs: [detect-changes, get-version]
    if: ${{ needs.detect-changes.outputs.auth == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Run Auth-Service tests
      run: |
        echo "üß™ Ejecutando pruebas de Auth-Service..."
        cd Auth-Service
        pip install -r requirements.txt
        pip install pytest pytest-flask
        python -m pytest tests/ -v --tb=short
        echo "‚úÖ Pruebas de Auth-Service pasaron correctamente!"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker gcr.io
        gcloud auth configure-docker us-docker.pkg.dev

    - name: Verify Docker authentication
      run: |
        echo "Verificando autenticaci√≥n de Docker..."
        gcloud auth list
        docker pull hello-world
        echo "‚úÖ Docker autenticado correctamente"

    - name: Install gke-gcloud-auth-plugin
      run: |
        echo "Instalando gke-gcloud-auth-plugin..."
        gcloud components install gke-gcloud-auth-plugin --quiet
        echo "‚úÖ Plugin instalado correctamente"

    - name: Get GKE credentials
      run: gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}

    - name: Build and push Auth-Service image
      run: |
        cd Auth-Service
        echo "üèóÔ∏è Building Auth-Service with version ${{ needs.get-version.outputs.version }}"
        docker build \
          --build-arg VERSION=${{ needs.get-version.outputs.version }} \
          --build-arg BUILD_DATE=${{ needs.get-version.outputs.build_date }} \
          --build-arg COMMIT_HASH=${{ github.sha }} \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/auth-service:${{ needs.get-version.outputs.version }} \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/auth-service:latest \
          .
        echo "üì§ Pushing images..."
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/auth-service:${{ needs.get-version.outputs.version }}
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/auth-service:latest
        echo "‚úÖ Images pushed successfully!"

    - name: Deploy Auth-Service
      run: |
        echo "üöÄ Deploying Auth-Service version ${{ needs.get-version.outputs.version }}"
        kubectl set image deployment/auth-deployment auth-service=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/auth-service:${{ needs.get-version.outputs.version }} -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout status deployment/auth-deployment -n ${{ env.GKE_NAMESPACE }} --timeout=300s
        echo "‚úÖ Auth-Service deployed successfully!"

  deploy-config:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.config == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Install gke-gcloud-auth-plugin
      run: |
        echo "Instalando gke-gcloud-auth-plugin..."
        gcloud components install gke-gcloud-auth-plugin --quiet
        echo "‚úÖ Plugin instalado correctamente"

    - name: Get GKE credentials
      run: gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}

    - name: Deploy configuration
      run: |
        echo "üîß Desplegando configuraci√≥n de Kubernetes..."
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secret.yaml
        kubectl apply -f k8s/ingress.yaml
        echo "‚úÖ Configuraci√≥n desplegada correctamente!"

  verify-deployment:
    needs: [detect-changes, deploy-productos, deploy-usuarios, deploy-ventas, deploy-logistica, deploy-auth, deploy-config]
    if: always() && (needs.detect-changes.outputs.productos == 'true' || needs.detect-changes.outputs.usuarios == 'true' || needs.detect-changes.outputs.ventas == 'true' || needs.detect-changes.outputs.logistica == 'true' || needs.detect-changes.outputs.auth == 'true' || needs.detect-changes.outputs.config == 'true')
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Install gke-gcloud-auth-plugin
      run: |
        echo "Instalando gke-gcloud-auth-plugin..."
        gcloud components install gke-gcloud-auth-plugin --quiet
        echo "‚úÖ Plugin instalado correctamente"

    - name: Get GKE credentials
      run: gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}

    - name: Verify deployment
      run: |
        echo "Verificando estado de los pods..."
        kubectl get pods -n ${{ env.GKE_NAMESPACE }}
        
        echo "Verificando estado de los servicios..."
        kubectl get services -n ${{ env.GKE_NAMESPACE }}
        
        echo "Verificando estado del Ingress..."
        kubectl get ingress -n ${{ env.GKE_NAMESPACE }}
        
        echo "Obteniendo IP del Ingress..."
        INGRESS_IP=$(kubectl get ingress -n ${{ env.GKE_NAMESPACE }} -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}')
        echo "Ingress IP: $INGRESS_IP"
        
        echo "Probando endpoints..."
        if [ ! -z "$INGRESS_IP" ]; then
          echo "Probando ruta ra√≠z..."
          curl -f http://$INGRESS_IP/ || echo "Error en ruta ra√≠z"
        fi
